<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Least Squares Regression Applet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .data-input {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .data-input h3 {
            margin-top: 0;
            color: #495057;
            text-align: center;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        
        textarea {
            height: 120px;
            resize: vertical;
            font-family: monospace;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .clear-btn {
            background: #6c757d;
        }
        
        .clear-btn:hover {
            background: #545b62;
        }
        
        .results {
            margin-bottom: 30px;
        }
        
        .equation {
            background: #e7f3ff;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 15px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
            margin-top: 5px;
        }
        
        .chart-container {
            position: relative;
            height: 500px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .instructions {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Least Squares Regression Analysis</h1>
        
        <div class="instructions">
            <strong>Instructions:</strong> Enter your data variable names and numerical values separated by commas (e.g., 1,2,3,4,5). 
            Both datasets must have the same number of values. Click "Generate Graph" to create the scatter plot with regression line.
        </div>
        
        <div class="input-section">
            <div class="data-input">
                <h3>X Variable (Independent)</h3>
                <label for="x-name">Variable Name:</label>
                <input type="text" id="x-name" placeholder="e.g., Time" value="">
                
                <label for="x-data">Data Values:</label>
                <textarea id="x-data" placeholder="Enter comma-separated values
e.g., 1,2,3,4,5"></textarea>
            </div>
            
            <div class="data-input">
                <h3>Y Variable (Dependent)</h3>
                <label for="y-name">Variable Name:</label>
                <input type="text" id="y-name" placeholder="e.g., Distance" value="">
                
                <label for="y-data">Data Values:</label>
                <textarea id="y-data" placeholder="Enter comma-separated values
e.g., 2,4,6,8,10"></textarea>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="generateGraph()">Generate Graph</button>
            <button onclick="clearAll()" class="clear-btn">Clear All</button>
            
            <div class="visualization-options" style="margin-top: 20px;">
                <h4 style="margin-bottom: 10px; color: #495057;">Visualization Options</h4>
                <label style="display: inline-block; margin-right: 20px;">
                    <input type="checkbox" id="show-origin"> Show Origin (0,0)
                </label>
                <label style="display: inline-block; margin-right: 20px;">
                    <input type="checkbox" id="show-intercept"> Show Y-Intercept
                </label>
                <label style="display: inline-block;">
                    <input type="checkbox" id="show-gradient"> Show Gradient
                </label>
            </div>
        </div>
        
        <div id="error-message"></div>
        
        <div id="results" class="results" style="display: none;">
            <div id="equation" class="equation"></div>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">Correlation (r)</div>
                    <div class="stat-value" id="correlation">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">R-squared</div>
                    <div class="stat-value" id="r-squared">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Sample Size</div>
                    <div class="stat-value" id="sample-size">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Slope</div>
                    <div class="stat-value" id="slope">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Y-intercept</div>
                    <div class="stat-value" id="intercept">-</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="regressionChart"></canvas>
                <button id="download-chart" onclick="downloadChart()" style="position: absolute; bottom: 10px; right: 10px; background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">Download PNG</button>
            </div>
        </div>
        
        <div id="prediction-tool" class="prediction-tool" style="display: none;">
            <h3 style="color: #495057; margin-bottom: 15px;">Prediction Tool</h3>
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <label for="predict-input" style="margin: 0; white-space: nowrap;">Enter <span id="x-var-name">x</span> value:</label>
                <input type="number" id="predict-input" placeholder="Enter value" style="width: 150px; margin: 0;">
            </div>
            <div id="prediction-result" style="background: #e7f3ff; border: 2px solid #007bff; border-radius: 8px; padding: 15px; text-align: center; font-size: 16px; font-weight: bold; color: #0056b3; display: none;">
                <span id="prediction-text"></span>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let currentData = null;
        let predictionValue = null;
        
        function parseData(dataString) {
            return dataString.split(',')
                           .map(x => x.trim())
                           .filter(x => x !== '')
                           .map(x => parseFloat(x))
                           .filter(x => !isNaN(x));
        }
        
        function calculateRegression(xData, yData) {
            const n = xData.length;
            
            // Calculate means
            const xMean = xData.reduce((sum, x) => sum + x, 0) / n;
            const yMean = yData.reduce((sum, y) => sum + y, 0) / n;
            
            // Calculate slope (b1) and intercept (b0)
            let numerator = 0;
            let denominator = 0;
            
            for (let i = 0; i < n; i++) {
                numerator += (xData[i] - xMean) * (yData[i] - yMean);
                denominator += (xData[i] - xMean) * (xData[i] - xMean);
            }
            
            const slope = numerator / denominator;
            const intercept = yMean - slope * xMean;
            
            // Calculate correlation coefficient
            let sumXY = 0, sumX2 = 0, sumY2 = 0;
            for (let i = 0; i < n; i++) {
                const dx = xData[i] - xMean;
                const dy = yData[i] - yMean;
                sumXY += dx * dy;
                sumX2 += dx * dx;
                sumY2 += dy * dy;
            }
            
            const correlation = sumXY / Math.sqrt(sumX2 * sumY2);
            const rSquared = correlation * correlation;
            
            return { slope, intercept, correlation, rSquared };
        }
        
        function formatNumber(num, decimals = 4) {
            if (Math.abs(num) < 0.0001 && num !== 0) {
                return num.toExponential(3);
            }
            return Number(num.toFixed(decimals));
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
            document.getElementById('results').style.display = 'none';
        }
        
        function clearError() {
            document.getElementById('error-message').innerHTML = '';
        }
        
        function generateGraph() {
            clearError();
            
            // Get input values
            const xName = document.getElementById('x-name').value.trim() || 'x';
            const yName = document.getElementById('y-name').value.trim() || 'y';
            const xDataString = document.getElementById('x-data').value.trim();
            const yDataString = document.getElementById('y-data').value.trim();
            
            if (!xDataString || !yDataString) {
                showError('Please enter data for both variables.');
                return;
            }
            
            // Parse data
            const xData = parseData(xDataString);
            const yData = parseData(yDataString);
            
            // Validate data
            if (xData.length < 2 || yData.length < 2) {
                showError('Please enter at least 2 data points for each variable.');
                return;
            }
            
            if (xData.length !== yData.length) {
                showError(`Data length mismatch: X has ${xData.length} values, Y has ${yData.length} values.`);
                return;
            }
            
            // Check for constant x values (would cause division by zero)
            const xRange = Math.max(...xData) - Math.min(...xData);
            if (xRange === 0) {
                showError('X values cannot all be the same (no variation in independent variable).');
                return;
            }
            
            // Calculate regression
            const { slope, intercept, correlation, rSquared } = calculateRegression(xData, yData);
            
            // Store current data for chart updates
            currentData = {
                xData, yData, xName, yName, slope, intercept, correlation, rSquared
            };
            
            // Display equation
            const slopeStr = formatNumber(slope);
            const interceptStr = formatNumber(intercept);
            const interceptSign = intercept >= 0 ? '+' : '';
            
            document.getElementById('equation').innerHTML = 
                `${yName} = ${slopeStr} × ${xName} ${interceptSign} ${interceptStr}`;
            
            // Display statistics
            document.getElementById('correlation').textContent = formatNumber(correlation);
            document.getElementById('r-squared').textContent = formatNumber(rSquared);
            document.getElementById('sample-size').textContent = xData.length;
            document.getElementById('slope').textContent = formatNumber(slope);
            document.getElementById('intercept').textContent = formatNumber(intercept);
            
            // Create/update chart
            updateChart();
            
            // Update prediction tool variable name and show it
            document.getElementById('x-var-name').textContent = xName;
            document.getElementById('prediction-tool').style.display = 'block';
            document.getElementById('results').style.display = 'block';
        }
        
        function makePrediction() {
            if (!currentData) return;
            
            const inputValue = parseFloat(document.getElementById('predict-input').value);
            if (isNaN(inputValue)) {
                document.getElementById('prediction-result').style.display = 'none';
                predictionValue = null;
                updateChart();
                return;
            }
            
            const { slope, intercept, yName, xName } = currentData;
            const predictedValue = slope * inputValue + intercept;
            
            document.getElementById('prediction-text').innerHTML = 
                `${yName} = ${formatNumber(slope, 4)} × ${inputValue} + ${formatNumber(intercept, 4)} = ${formatNumber(predictedValue, 4)}`;
            document.getElementById('prediction-result').style.display = 'block';
            
            predictionValue = { x: inputValue, y: predictedValue };
            updateChart();
        }
        
        function downloadChart() {
            if (!chart) return;
            
            const link = document.createElement('a');
            link.download = 'regression-chart.png';
            link.href = chart.toBase64Image();
            link.click();
        }
        
        function updateChart() {
            if (!currentData) return;
            
            const { xData, yData, xName, yName, slope, intercept } = currentData;
            
            // Create scatter plot with regression line
            const ctx = document.getElementById('regressionChart').getContext('2d');
            
            // Destroy existing chart
            if (chart) {
                chart.destroy();
            }
            
            // Prepare data points
            const scatterData = xData.map((x, i) => ({ x: x, y: yData[i] }));
            
            // Create regression line points
            const xMin = Math.min(...xData);
            const xMax = Math.max(...xData);
            
            // Check visualization options
            const showOrigin = document.getElementById('show-origin').checked;
            const showIntercept = document.getElementById('show-intercept').checked;
            const showGradient = document.getElementById('show-gradient').checked;
            
            // Determine line extent based on options
            const lineStartX = (showOrigin || showIntercept) ? 0 : xMin;
            const regressionLine = [
                { x: lineStartX, y: slope * lineStartX + intercept },
                { x: xMax, y: slope * xMax + intercept }
            ];
            
            // Build datasets array
            const datasets = [{
                label: 'Data Points',
                data: scatterData,
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                pointRadius: 6,
                pointHoverRadius: 8
            }];
            
            // Add solid regression line (data range)
            datasets.push({
                label: 'Regression Line',
                data: [
                    { x: xMin, y: slope * xMin + intercept },
                    { x: xMax, y: slope * xMax + intercept }
                ],
                type: 'line',
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                borderWidth: 3,
                pointRadius: 0,
                pointHoverRadius: 0,
                tension: 0
            });
            
            // Add dashed extension to x=0 if needed (only for y-intercept)
            if (showIntercept && lineStartX < xMin) {
                datasets.push({
                    label: '',
                    data: [
                        { x: lineStartX, y: slope * lineStartX + intercept },
                        { x: xMin, y: slope * xMin + intercept }
                    ],
                    type: 'line',
                    borderColor: 'rgba(255, 99, 132, 0.7)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    tension: 0,
                    skipLegend: true
                });
            }
            
            // Add prediction point and extrapolation if there's a prediction
            if (predictionValue) {
                const predX = predictionValue.x;
                const predY = predictionValue.y;
                
                // Add prediction point
                datasets.push({
                    label: '',
                    data: [{ x: predX, y: predY }],
                    backgroundColor: 'rgba(255, 0, 255, 0.8)',
                    borderColor: 'rgba(255, 0, 255, 1)',
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    pointStyle: 'circle',
                    skipLegend: true
                });
                
                // Calculate chart view boundaries
                const chartMinX = showOrigin ? 0 : Math.min(xMin, predX);
                const allYValues = [...yData, predY];
                if (showIntercept) allYValues.push(intercept);
                const chartMinY = showOrigin ? 0 : Math.min(...allYValues);
                
                // Add dotted vertical line from chart bottom to prediction point
                datasets.push({
                    label: '',
                    data: [
                        { x: predX, y: chartMinY },
                        { x: predX, y: predY }
                    ],
                    type: 'line',
                    borderColor: 'rgba(255, 0, 255, 0.6)',
                    borderWidth: 1,
                    borderDash: [3, 3],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    tension: 0,
                    skipLegend: true
                });
                
                // Add dotted horizontal line from chart left to prediction point
                datasets.push({
                    label: '',
                    data: [
                        { x: chartMinX, y: predY },
                        { x: predX, y: predY }
                    ],
                    type: 'line',
                    borderColor: 'rgba(255, 0, 255, 0.6)',
                    borderWidth: 1,
                    borderDash: [3, 3],
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    tension: 0,
                    skipLegend: true
                });
                
                // Add extrapolation line if prediction is beyond data range
                if (predX > xMax) {
                    datasets.push({
                        label: '',
                        data: [
                            { x: xMax, y: slope * xMax + intercept },
                            { x: predX, y: predY }
                        ],
                        type: 'line',
                        borderColor: 'rgba(255, 99, 132, 0.7)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        tension: 0,
                        skipLegend: true
                    });
                } else if (predX < xMin) {
                    datasets.push({
                        label: '',
                        data: [
                            { x: predX, y: predY },
                            { x: xMin, y: slope * xMin + intercept }
                        ],
                        type: 'line',
                        borderColor: 'rgba(255, 99, 132, 0.7)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        tension: 0,
                        skipLegend: true
                    });
                }
            }
            
            
            // Add y-intercept point if enabled
            if (showIntercept) {
                datasets.push({
                    label: `Y-Intercept (0, ${formatNumber(intercept, 2)})`,
                    data: [{ x: 0, y: intercept }],
                    backgroundColor: 'rgba(255, 165, 0, 0.8)',
                    borderColor: 'rgba(255, 140, 0, 1)',
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    pointStyle: 'triangle'
                });
            }
            
            // Add gradient demonstration if enabled
            if (showGradient) {
                const midX = (xMin + xMax) / 2;
                const midY = slope * midX + intercept;
                const deltaX = (xMax - xMin) * 0.3;
                const deltaY = slope * deltaX;
                
                // Gradient triangle
                datasets.push({
                    label: `Gradient Triangle (Δy/Δx = ${formatNumber(slope, 2)})`,
                    data: [
                        { x: midX, y: midY },
                        { x: midX + deltaX, y: midY },
                        { x: midX + deltaX, y: midY + deltaY }
                    ],
                    type: 'line',
                    borderColor: 'rgba(34, 139, 34, 1)',
                    backgroundColor: 'rgba(34, 139, 34, 0.2)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointBackgroundColor: 'rgba(34, 139, 34, 1)',
                    fill: false,
                    tension: 0
                });
                
            }
            
            chart = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'point'
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xName,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            beginAtZero: showOrigin
                        },
                        y: {
                            title: {
                                display: true,
                                text: yName,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            beginAtZero: showOrigin
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            filter: function(legendItem, chart) {
                                const dataset = chart.data.datasets[legendItem.datasetIndex];
                                return !dataset.skipLegend;
                            }
                        },
                        title: {
                            display: true,
                            text: `Scatter Plot: ${yName} vs ${xName}`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `${xName}: ${context[0].parsed.x}`;
                                },
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return `${yName}: ${context.parsed.y}`;
                                    } else {
                                        return `Predicted ${yName}: ${formatNumber(context.parsed.y, 2)}`;
                                    }
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'customLabels',
                    afterDraw: function(chart) {
                        if (!currentData) return;
                        
                        const ctx = chart.ctx;
                        const { xData, yData, slope, intercept } = currentData;
                        const showOrigin = document.getElementById('show-origin').checked;
                        const showIntercept = document.getElementById('show-intercept').checked;
                        const showGradient = document.getElementById('show-gradient').checked;
                        
                        // Draw gradient labels if enabled
                        if (showGradient) {
                            const xMin = Math.min(...xData);
                            const xMax = Math.max(...xData);
                            const midX = (xMin + xMax) / 2;
                            const midY = slope * midX + intercept;
                            const deltaX = (xMax - xMin) * 0.3;
                            const deltaY = slope * deltaX;
                            
                            ctx.save();
                            ctx.fillStyle = 'rgba(34, 139, 34, 1)';
                            ctx.font = '12px Arial';
                            
                            // Run label: middle of horizontal line, below
                            const runMidX = chart.scales.x.getPixelForValue(midX + deltaX/2);
                            const runY = chart.scales.y.getPixelForValue(midY);
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'top';
                            ctx.fillText(`run = ${formatNumber(deltaX, 2)}`, runMidX, runY + 8);
                            
                            // Rise label: middle of vertical line, to the right
                            const riseX = chart.scales.x.getPixelForValue(midX + deltaX);
                            const riseMidY = chart.scales.y.getPixelForValue(midY + deltaY/2);
                            ctx.textAlign = 'left';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(`rise = ${formatNumber(deltaY, 2)}`, riseX + 8, riseMidY);
                            
                            ctx.restore();
                        }
                        
                        // Draw y-intercept label if enabled
                        if (showIntercept) {
                            ctx.save();
                            ctx.fillStyle = 'rgba(255, 140, 0, 1)';
                            ctx.font = '12px Arial';
                            ctx.textAlign = 'left';
                            ctx.textBaseline = 'middle';
                            const interceptX = chart.scales.x.getPixelForValue(0);
                            const interceptY = chart.scales.y.getPixelForValue(intercept);
                            ctx.fillText(`(0, ${formatNumber(intercept, 2)})`, interceptX + 8, interceptY);
                            ctx.restore();
                        }
                    }
                }]
            });
        }
        
        function clearAll() {
            document.getElementById('x-name').value = '';
            document.getElementById('y-name').value = '';
            document.getElementById('x-data').value = '';
            document.getElementById('y-data').value = '';
            document.getElementById('results').style.display = 'none';
            document.getElementById('prediction-tool').style.display = 'none';
            document.getElementById('prediction-result').style.display = 'none';
            document.getElementById('predict-input').value = '';
            clearError();
            
            if (chart) {
                chart.destroy();
                chart = null;
            }
            
            currentData = null;
            predictionValue = null;
        }
        
        // Example data for demonstration
        function loadExample() {
            document.getElementById('x-name').value = 'Study Hours';
            document.getElementById('y-name').value = 'Test Score';
            document.getElementById('x-data').value = '5,6,7,8,9,10,11,12';
            document.getElementById('y-data').value = '45,55,60,70,75,80,85,90';
        }
        
        // Add example button and event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const controlsDiv = document.querySelector('.controls');
            const exampleBtn = document.createElement('button');
            exampleBtn.textContent = 'Load Example';
            exampleBtn.style.background = '#28a745';
            exampleBtn.onclick = loadExample;
            exampleBtn.onmouseover = function() { this.style.background = '#1e7e34'; };
            exampleBtn.onmouseout = function() { this.style.background = '#28a745'; };
            controlsDiv.appendChild(exampleBtn);
            
            // Add event listeners for visualization options
            document.getElementById('show-origin').addEventListener('change', updateChart);
            document.getElementById('show-intercept').addEventListener('change', updateChart);
            document.getElementById('show-gradient').addEventListener('change', updateChart);
            
            // Add event listener for real-time prediction
            document.getElementById('predict-input').addEventListener('input', makePrediction);
        });
    </script>
</body>
</html>